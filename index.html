<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Ìè¨ÏºìÎ™¨ Ïñ¥ÎìúÎ≤§Ï≤ò</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            font-family: 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        #gameContainer {
            position: relative;
            width: 100%;
            height: 100vh;
            background: #0f3460;
            display: flex;
            flex-direction: column;
        }

        canvas {
            display: block;
            background: #2d2d44;
            width: 100%;
            flex: 1;
            touch-action: none;
        }

        .ui-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
            z-index: 10;
        }

        .stat-box {
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 12px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .player-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .hp-bar-container {
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 12px;
            border-radius: 8px;
            min-width: 150px;
        }

        .pokemon-name {
            color: #ffd700;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .hp-bar-bg {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #555;
        }

        .hp-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: bold;
        }

        .hp-bar.low {
            background: linear-gradient(90deg, #ff6b6b, #ee5a6f);
        }

        .game-stats {
            text-align: right;
        }

        .level-display {
            color: #4ecdc4;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .exp-bar {
            width: 100px;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 3px;
        }

        .exp-fill {
            height: 100%;
            background: linear-gradient(90deg, #9b59b6, #e74c3c);
            transition: width 0.3s;
        }

        .score-display {
            color: #ffd700;
            font-size: 14px;
        }

        /* Î™®Î∞îÏùº Ïª®Ìä∏Î°§ */
        .mobile-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            pointer-events: none;
            z-index: 100;
        }

        .joystick-area {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 140px;
            height: 140px;
            pointer-events: auto;
        }

        .joystick-base {
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.3);
            position: relative;
        }

        .joystick-stick {
            position: absolute;
            width: 50px;
            height: 50px;
            background: rgba(78, 205, 196, 0.7);
            border-radius: 50%;
            border: 3px solid #4ecdc4;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.1s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .action-buttons {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            pointer-events: auto;
        }

        .action-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            cursor: pointer;
            transition: all 0.1s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            position: relative;
        }

        .action-btn:active {
            transform: scale(0.9);
        }

        .attack-btn {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.3);
        }

        .skill-btn {
            border-color: #9b59b6;
            background: rgba(155, 89, 182, 0.3);
        }

        .skill-cooldown {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            font-weight: bold;
        }

        /* ÏãúÏûë ÌôîÎ©¥ */
        #startScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        #startScreen.hidden {
            display: none;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            text-align: center;
        }

        .subtitle {
            color: #4ecdc4;
            font-size: 16px;
            margin-bottom: 30px;
        }

        .trainer-name-input {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #4ecdc4;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 16px;
            text-align: center;
            margin-bottom: 20px;
            width: 250px;
        }

        .trainer-name-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .pokemon-select {
            display: flex;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .pokemon-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            text-align: center;
            min-width: 120px;
        }

        .pokemon-card.selected {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.2);
            transform: scale(1.05);
        }

        .pokemon-icon {
            font-size: 50px;
            margin-bottom: 8px;
        }

        .pokemon-name-display {
            font-size: 16px;
            font-weight: bold;
            color: white;
            margin-bottom: 5px;
        }

        .pokemon-type {
            font-size: 11px;
            color: #aaa;
            background: rgba(0, 0, 0, 0.3);
            padding: 3px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-bottom: 5px;
        }

        .pokemon-stats {
            font-size: 11px;
            color: #aaa;
        }

        .start-btn {
            background: #4ecdc4;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 20px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            margin-top: 20px;
        }

        .start-btn:active {
            transform: scale(0.95);
        }

        .start-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .leaderboard-btn {
            background: rgba(255, 215, 0, 0.3);
            border: 2px solid #ffd700;
            color: #ffd700;
            padding: 10px 30px;
            font-size: 16px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 15px;
        }

        /* Í≤åÏûÑÏò§Î≤Ñ ÌôîÎ©¥ */
        #gameOverScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        #gameOverScreen.hidden {
            display: none;
        }

        .game-over-title {
            font-size: 2.5em;
            color: #e74c3c;
            margin-bottom: 30px;
            text-shadow: 0 0 20px rgba(231, 76, 60, 0.5);
        }

        .final-stats {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .stats {
            color: white;
            font-size: 18px;
            margin: 10px 0;
        }

        .restart-btn {
            background: #4ecdc4;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 20px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            margin-top: 30px;
        }

        .restart-btn:active {
            transform: scale(0.95);
        }

        /* Î¶¨ÎçîÎ≥¥Îìú ÌôîÎ©¥ */
        #leaderboardScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        #leaderboardScreen.hidden {
            display: none;
        }

        .leaderboard-list {
            width: 100%;
            max-width: 500px;
            margin: 20px 0;
        }

        .leaderboard-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .leaderboard-item.top3 {
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid #ffd700;
        }

        .rank {
            font-size: 24px;
            font-weight: bold;
            width: 50px;
        }

        .trainer-info {
            flex: 1;
            margin-left: 15px;
        }

        .trainer-name {
            font-size: 18px;
            font-weight: bold;
        }

        .trainer-pokemon {
            font-size: 12px;
            color: #aaa;
        }

        .score {
            font-size: 20px;
            font-weight: bold;
            color: #ffd700;
        }

        .close-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 20px;
        }

        .loading {
            color: white;
            font-size: 18px;
            margin: 20px;
        }

        .level-up-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 215, 0, 0.95);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 500;
            animation: popupAppear 0.3s;
        }

        @keyframes popupAppear {
            from {
                transform: translate(-50%, -50%) scale(0);
            }
            to {
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .level-up-popup h2 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .level-up-popup p {
            color: #666;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        
        <div class="ui-overlay">
            <div class="player-info">
                <div class="hp-bar-container">
                    <div class="pokemon-name" id="pokemonName">ÌîºÏπ¥Ï∏Ñ</div>
                    <div class="hp-bar-bg">
                        <div class="hp-bar" id="hpBar" style="width: 100%;">100/100</div>
                    </div>
                </div>
            </div>
            <div class="stat-box game-stats">
                <div class="level-display" id="levelDisplay">Î†àÎ≤®: 1</div>
                <div class="exp-bar">
                    <div class="exp-fill" id="expBar" style="width: 0%"></div>
                </div>
                <div class="score-display" id="scoreDisplay">Ï†êÏàò: 0</div>
            </div>
        </div>

        <div class="mobile-controls">
            <div class="joystick-area" id="joystickArea">
                <div class="joystick-base">
                    <div class="joystick-stick" id="joystickStick"></div>
                </div>
            </div>

            <div class="action-buttons">
                <div class="action-btn attack-btn" id="attackBtn">‚ö°</div>
                <div class="action-btn skill-btn" id="skillBtn">
                    üí•
                    <div class="skill-cooldown hidden" id="skillCooldown">0</div>
                </div>
            </div>
        </div>

        <div id="startScreen">
            <h1>‚ö° Ìè¨ÏºìÎ™¨ Ïñ¥ÎìúÎ≤§Ï≤ò ‚ö°</h1>
            <p class="subtitle">Ìä∏Î†àÏù¥ÎÑà Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÍ≥† Ìè¨ÏºìÎ™¨ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî!</p>
            
            <input type="text" class="trainer-name-input" id="trainerName" placeholder="Ìä∏Î†àÏù¥ÎÑà Ïù¥Î¶Ñ" maxlength="10">

            <div class="pokemon-select">
                <div class="pokemon-card" data-pokemon="pikachu">
                    <div class="pokemon-icon">‚ö°</div>
                    <div class="pokemon-name-display">ÌîºÏπ¥Ï∏Ñ</div>
                    <div class="pokemon-type">Ï†ÑÍ∏∞</div>
                    <div class="pokemon-stats">HP: 100 | Îπ†Î•∏ Í≥µÍ≤©</div>
                </div>
                <div class="pokemon-card" data-pokemon="charmander">
                    <div class="pokemon-icon">üî•</div>
                    <div class="pokemon-name-display">ÌååÏù¥Î¶¨</div>
                    <div class="pokemon-type">Î∂àÍΩÉ</div>
                    <div class="pokemon-stats">HP: 120 | Í∞ïÌïú Í≥µÍ≤©</div>
                </div>
                <div class="pokemon-card" data-pokemon="squirtle">
                    <div class="pokemon-icon">üíß</div>
                    <div class="pokemon-name-display">Íº¨Î∂ÄÍ∏∞</div>
                    <div class="pokemon-type">Î¨º</div>
                    <div class="pokemon-stats">HP: 130 | Î∞©Ïñ¥Î†• ÎÜíÏùå</div>
                </div>
            </div>

            <button class="start-btn" id="startBtn" disabled>Í≤åÏûÑ ÏãúÏûë</button>
            <button class="leaderboard-btn" id="showLeaderboardBtn">üèÜ Î¶¨ÎçîÎ≥¥Îìú</button>
        </div>

        <div id="gameOverScreen" class="hidden">
            <h1 class="game-over-title">Í≤åÏûÑ Ïò§Î≤Ñ</h1>
            <div class="final-stats">
                <div class="stats">Î†àÎ≤®: <span id="finalLevel">0</span></div>
                <div class="stats">Ï†êÏàò: <span id="finalScore">0</span></div>
                <div class="stats">Ï≤òÏπò: <span id="finalKills">0</span></div>
            </div>
            <p style="color: #4ecdc4; font-size: 16px; margin: 10px 0;">Ï†êÏàòÍ∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!</p>
            <button class="restart-btn" id="restartBtn">Îã§Ïãú ÏãúÏûë</button>
            <button class="leaderboard-btn" id="showLeaderboardBtn2">üèÜ Î¶¨ÎçîÎ≥¥Îìú</button>
        </div>

        <div id="leaderboardScreen" class="hidden">
            <h1>üèÜ Î¶¨ÎçîÎ≥¥Îìú üèÜ</h1>
            <div class="loading" id="leaderboardLoading">Î°úÎî©Ï§ë...</div>
            <div class="leaderboard-list" id="leaderboardList"></div>
            <button class="close-btn" id="closeLeaderboardBtn">Îã´Í∏∞</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, push, get, query, orderByChild, limitToLast } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAj0M7AuQnOlnWV1ZDcuY0Ij9eOV7SRUlg",
            authDomain: "free-96bc0.firebaseapp.com",
            databaseURL: "https://free-96bc0-default-rtdb.firebaseio.com",
            projectId: "free-96bc0",
            storageBucket: "free-96bc0.firebasestorage.app",
            messagingSenderId: "131017218548",
            appId: "1:131017218548:web:55ee3cb626695ede9841a1"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Firebase Ìï®ÏàòÎ•º Ï†ÑÏó≠ÏúºÎ°ú ÎÖ∏Ï∂ú
        window.saveScore = async function(trainerName, pokemon, level, score, kills) {
            try {
                const scoresRef = ref(database, 'pokemon-game/scores');
                const newScoreRef = push(scoresRef);
                await set(newScoreRef, {
                    trainerName: trainerName,
                    pokemon: pokemon,
                    level: level,
                    score: score,
                    kills: kills,
                    timestamp: Date.now()
                });
                console.log('Ï†êÏàò Ï†ÄÏû• ÏÑ±Í≥µ!');
            } catch (error) {
                console.error('Ï†êÏàò Ï†ÄÏû• Ïã§Ìå®:', error);
            }
        };

        window.loadLeaderboard = async function() {
            try {
                const scoresRef = ref(database, 'pokemon-game/scores');
                const topScoresQuery = query(scoresRef, orderByChild('score'), limitToLast(10));
                const snapshot = await get(topScoresQuery);
                
                const scores = [];
                snapshot.forEach((childSnapshot) => {
                    scores.push(childSnapshot.val());
                });
                
                // Ï†êÏàò ÎÜíÏùÄ ÏàúÏúºÎ°ú Ï†ïÎ†¨
                scores.sort((a, b) => b.score - a.score);
                return scores;
            } catch (error) {
                console.error('Î¶¨ÎçîÎ≥¥Îìú Î°úÎî© Ïã§Ìå®:', error);
                return [];
            }
        };

        console.log('Firebase Ï¥àÍ∏∞Ìôî ÏôÑÎ£å!');
    </script>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight - 200;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Í≤åÏûÑ ÏÉÅÌÉú
        let gameState = 'menu';
        let selectedPokemon = null;
        let trainerNameValue = '';
        let player = null;
        let enemies = [];
        let projectiles = [];
        let particles = [];
        let level = 1;
        let exp = 0;
        let expToNextLevel = 100;
        let score = 0;
        let kills = 0;
        let enemiesInWave = 0;

        // Ï°∞Ïù¥Ïä§Ìã±
        let joystickActive = false;
        let joystickStart = { x: 0, y: 0 };
        let joystickCurrent = { x: 0, y: 0 };
        let moveDirection = { x: 0, y: 0 };

        // Ìè¨ÏºìÎ™¨ Îç∞Ïù¥ÌÑ∞
        const pokemonData = {
            pikachu: {
                name: 'ÌîºÏπ¥Ï∏Ñ',
                icon: '‚ö°',
                maxHp: 100,
                speed: 4,
                attackDamage: 20,
                attackRange: 150,
                attackCooldown: 300,
                skillDamage: 60,
                skillRange: 200,
                skillCooldown: 4000,
                color: '#FFD700',
                projectileColor: '#FFFF00'
            },
            charmander: {
                name: 'ÌååÏù¥Î¶¨',
                icon: 'üî•',
                maxHp: 120,
                speed: 3,
                attackDamage: 30,
                attackRange: 130,
                attackCooldown: 400,
                skillDamage: 100,
                skillRange: 180,
                skillCooldown: 5000,
                color: '#FF6B4A',
                projectileColor: '#FF4500'
            },
            squirtle: {
                name: 'Íº¨Î∂ÄÍ∏∞',
                icon: 'üíß',
                maxHp: 130,
                speed: 3.5,
                attackDamage: 25,
                attackRange: 140,
                attackCooldown: 350,
                skillDamage: 80,
                skillRange: 190,
                skillCooldown: 4500,
                color: '#4A90E2',
                projectileColor: '#1E90FF'
            }
        };

        // Ìè¨ÏºìÎ™¨ ÏÑ†ÌÉù
        document.querySelectorAll('.pokemon-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.pokemon-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                selectedPokemon = this.dataset.pokemon;
                checkStartButton();
            });
        });

        document.getElementById('trainerName').addEventListener('input', checkStartButton);

        function checkStartButton() {
            const nameInput = document.getElementById('trainerName').value.trim();
            if (nameInput && selectedPokemon) {
                document.getElementById('startBtn').disabled = false;
            } else {
                document.getElementById('startBtn').disabled = true;
            }
        }

        document.getElementById('startBtn').addEventListener('click', startGame);
        document.getElementById('restartBtn').addEventListener('click', () => {
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
        });

        document.getElementById('showLeaderboardBtn').addEventListener('click', showLeaderboard);
        document.getElementById('showLeaderboardBtn2').addEventListener('click', showLeaderboard);
        document.getElementById('closeLeaderboardBtn').addEventListener('click', () => {
            document.getElementById('leaderboardScreen').classList.add('hidden');
            if (gameState === 'menu') {
                document.getElementById('startScreen').classList.remove('hidden');
            } else {
                document.getElementById('gameOverScreen').classList.remove('hidden');
            }
        });

        async function showLeaderboard() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('leaderboardScreen').classList.remove('hidden');
            document.getElementById('leaderboardLoading').style.display = 'block';
            document.getElementById('leaderboardList').innerHTML = '';

            const scores = await window.loadLeaderboard();
            
            document.getElementById('leaderboardLoading').style.display = 'none';

            if (scores.length === 0) {
                document.getElementById('leaderboardList').innerHTML = '<p style="color: white; text-align: center;">ÏïÑÏßÅ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }

            const listHtml = scores.map((score, index) => {
                const rank = index + 1;
                const isTop3 = rank <= 3;
                const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : '';
                
                return `
                    <div class="leaderboard-item ${isTop3 ? 'top3' : ''}">
                        <div class="rank">${medal || rank}</div>
                        <div class="trainer-info">
                            <div class="trainer-name">${score.trainerName}</div>
                            <div class="trainer-pokemon">${score.pokemon} | Î†àÎ≤® ${score.level}</div>
                        </div>
                        <div class="score">${score.score.toLocaleString()}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('leaderboardList').innerHTML = listHtml;
        }

        // Ï°∞Ïù¥Ïä§Ìã±
        const joystickArea = document.getElementById('joystickArea');
        const joystickStick = document.getElementById('joystickStick');

        joystickArea.addEventListener('touchstart', handleJoystickStart);
        joystickArea.addEventListener('touchmove', handleJoystickMove);
        joystickArea.addEventListener('touchend', handleJoystickEnd);

        function handleJoystickStart(e) {
            e.preventDefault();
            joystickActive = true;
            const rect = joystickArea.getBoundingClientRect();
            joystickStart.x = rect.left + rect.width / 2;
            joystickStart.y = rect.top + rect.height / 2;
        }

        function handleJoystickMove(e) {
            e.preventDefault();
            if (!joystickActive) return;

            const touch = e.touches[0];
            const dx = touch.clientX - joystickStart.x;
            const dy = touch.clientY - joystickStart.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const maxDistance = 45;

            if (distance > maxDistance) {
                joystickCurrent.x = (dx / distance) * maxDistance;
                joystickCurrent.y = (dy / distance) * maxDistance;
            } else {
                joystickCurrent.x = dx;
                joystickCurrent.y = dy;
            }

            joystickStick.style.transform = `translate(calc(-50% + ${joystickCurrent.x}px), calc(-50% + ${joystickCurrent.y}px))`;

            moveDirection.x = joystickCurrent.x / maxDistance;
            moveDirection.y = joystickCurrent.y / maxDistance;
        }

        function handleJoystickEnd(e) {
            e.preventDefault();
            joystickActive = false;
            joystickStick.style.transform = 'translate(-50%, -50%)';
            moveDirection.x = 0;
            moveDirection.y = 0;
        }

        // Í≥µÍ≤©/Ïä§ÌÇ¨
        let lastAttackTime = 0;
        let lastSkillTime = 0;
        let skillCooldownRemaining = 0;

        document.getElementById('attackBtn').addEventListener('touchstart', (e) => {
            e.preventDefault();
            performAttack();
        });

        document.getElementById('skillBtn').addEventListener('touchstart', (e) => {
            e.preventDefault();
            performSkill();
        });

        function startGame() {
            trainerNameValue = document.getElementById('trainerName').value.trim();
            if (!trainerNameValue || !selectedPokemon) return;

            const pokemonInfo = pokemonData[selectedPokemon];
            player = {
                x: canvas.width / 2,
                y: canvas.height / 2,
                size: 25,
                hp: pokemonInfo.maxHp,
                maxHp: pokemonInfo.maxHp,
                invulnerable: 0,
                ...pokemonInfo
            };

            enemies = [];
            projectiles = [];
            particles = [];
            level = 1;
            exp = 0;
            expToNextLevel = 100;
            score = 0;
            kills = 0;
            enemiesInWave = 0;
            lastAttackTime = 0;
            lastSkillTime = 0;

            document.getElementById('pokemonName').textContent = pokemonInfo.name;
            
            spawnWave();
            updateUI();

            gameState = 'playing';
            document.getElementById('startScreen').classList.add('hidden');
            
            gameLoop();
        }

        function spawnWave() {
            const count = 3 + level * 2;
            enemiesInWave = count;

            for (let i = 0; i < count; i++) {
                setTimeout(() => spawnEnemy(), i * 700);
            }
        }

        function spawnEnemy() {
            const side = Math.floor(Math.random() * 4);
            let x, y;

            const margin = 50;
            switch(side) {
                case 0: x = Math.random() * canvas.width; y = -margin; break;
                case 1: x = canvas.width + margin; y = Math.random() * canvas.height; break;
                case 2: x = Math.random() * canvas.width; y = canvas.height + margin; break;
                case 3: x = -margin; y = Math.random() * canvas.height; break;
            }

            const wildPokemon = [
                { icon: 'üëæ', hp: 20 + level * 5, speed: 1.5, size: 18, color: '#e74c3c', damage: 8, expReward: 10, scoreReward: 50 },
                { icon: 'ü¶á', hp: 30 + level * 7, speed: 2, size: 20, color: '#8e44ad', damage: 12, expReward: 15, scoreReward: 75 },
                { icon: 'üëª', hp: 40 + level * 10, speed: 1.2, size: 22, color: '#3498db', damage: 15, expReward: 20, scoreReward: 100 }
            ];

            const typeIndex = Math.min(Math.floor(level / 2), 2);
            const enemyType = wildPokemon[typeIndex];

            enemies.push({
                x, y,
                ...enemyType,
                maxHp: enemyType.hp
            });
        }

        function performAttack() {
            const now = Date.now();
            if (now - lastAttackTime < player.attackCooldown) return;
            lastAttackTime = now;

            const nearestEnemy = findNearestEnemy();
            if (!nearestEnemy) return;

            const dx = nearestEnemy.x - player.x;
            const dy = nearestEnemy.y - player.y;
            const dist = Math.sqrt(dx * dx + dy * dy);

            projectiles.push({
                x: player.x,
                y: player.y,
                vx: (dx / dist) * 8,
                vy: (dy / dist) * 8,
                damage: player.attackDamage,
                size: 8,
                color: player.projectileColor,
                maxDist: player.attackRange,
                traveled: 0
            });
        }

        function performSkill() {
            const now = Date.now();
            if (now - lastSkillTime < player.skillCooldown) return;
            lastSkillTime = now;

            // Í¥ëÏó≠ Í≥µÍ≤©
            enemies.forEach(enemy => {
                const dx = enemy.x - player.x;
                const dy = enemy.y - player.y;
                const dist = Math.sqrt(dx * dx + dy * dy);

                if (dist < player.skillRange) {
                    enemy.hp -= player.skillDamage;
                    createParticles(enemy.x, enemy.y, player.color, 15);

                    if (enemy.hp <= 0) {
                        killEnemy(enemy);
                    }
                }
            });

            createSkillEffect(player.x, player.y, player.skillRange, player.color);
        }

        function findNearestEnemy() {
            let nearest = null;
            let minDist = Infinity;

            enemies.forEach(enemy => {
                const dx = enemy.x - player.x;
                const dy = enemy.y - player.y;
                const dist = Math.sqrt(dx * dx + dy * dy);

                if (dist < minDist) {
                    minDist = dist;
                    nearest = enemy;
                }
            });

            return nearest;
        }

        function killEnemy(enemy) {
            const index = enemies.indexOf(enemy);
            if (index > -1) {
                enemies.splice(index, 1);
                kills++;
                enemiesInWave--;
                
                exp += enemy.expReward;
                score += enemy.scoreReward;

                checkLevelUp();
                updateUI();

                createParticles(enemy.x, enemy.y, enemy.color, 20);

                if (enemiesInWave === 0 && enemies.length === 0) {
                    setTimeout(spawnWave, 2000);
                }
            }
        }

        function checkLevelUp() {
            while (exp >= expToNextLevel) {
                exp -= expToNextLevel;
                level++;
                expToNextLevel = Math.floor(expToNextLevel * 1.5);
                
                // Î†àÎ≤®ÏóÖ Î≥¥ÏÉÅ
                player.hp = Math.min(player.maxHp, player.hp + 20);
                player.attackDamage += 5;
                
                showLevelUpPopup();
                updateUI();
            }
        }

        function showLevelUpPopup() {
            const popup = document.createElement('div');
            popup.className = 'level-up-popup';
            popup.innerHTML = `
                <h2>Î†àÎ≤® ÏóÖ!</h2>
                <p>Î†àÎ≤® ${level}</p>
            `;
            document.getElementById('gameContainer').appendChild(popup);

            setTimeout(() => {
                popup.remove();
            }, 2000);
        }

        function createParticles(x, y, color, count) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x, y,
                    vx: (Math.random() - 0.5) * 6,
                    vy: (Math.random() - 0.5) * 6,
                    life: 30,
                    maxLife: 30,
                    size: 3 + Math.random() * 3,
                    color
                });
            }
        }

        function createSkillEffect(x, y, range, color) {
            for (let i = 0; i < 40; i++) {
                const angle = (Math.PI * 2 / 40) * i;
                particles.push({
                    x: x + Math.cos(angle) * range,
                    y: y + Math.sin(angle) * range,
                    vx: Math.cos(angle) * 3,
                    vy: Math.sin(angle) * 3,
                    life: 25,
                    maxLife: 25,
                    size: 6,
                    color
                });
            }
        }

        function gameLoop() {
            if (gameState !== 'playing') return;

            update();
            render();
            requestAnimationFrame(gameLoop);
        }

        function update() {
            // ÌîåÎ†àÏù¥Ïñ¥ Ïù¥Îèô
            if (moveDirection.x !== 0 || moveDirection.y !== 0) {
                player.x += moveDirection.x * player.speed;
                player.y += moveDirection.y * player.speed;

                player.x = Math.max(player.size, Math.min(canvas.width - player.size, player.x));
                player.y = Math.max(player.size, Math.min(canvas.height - player.size, player.y));
            }

            if (player.invulnerable > 0) player.invulnerable--;

            // Î∞úÏÇ¨Ï≤¥
            projectiles = projectiles.filter(proj => {
                proj.x += proj.vx;
                proj.y += proj.vy;
                proj.traveled += Math.sqrt(proj.vx * proj.vx + proj.vy * proj.vy);

                if (proj.traveled > proj.maxDist) return false;
                if (proj.x < 0 || proj.x > canvas.width || proj.y < 0 || proj.y > canvas.height) return false;

                for (let i = enemies.length - 1; i >= 0; i--) {
                    const enemy = enemies[i];
                    const dx = proj.x - enemy.x;
                    const dy = proj.y - enemy.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < enemy.size + proj.size) {
                        enemy.hp -= proj.damage;
                        createParticles(enemy.x, enemy.y, enemy.color, 5);

                        if (enemy.hp <= 0) {
                            killEnemy(enemy);
                        }

                        return false;
                    }
                }

                return true;
            });

            // Ï†Å Ïù¥Îèô
            enemies.forEach(enemy => {
                const dx = player.x - enemy.x;
                const dy = player.y - enemy.y;
                const dist = Math.sqrt(dx * dx + dy * dy);

                if (dist > 0) {
                    enemy.x += (dx / dist) * enemy.speed;
                    enemy.y += (dy / dist) * enemy.speed;
                }

                if (dist < player.size + enemy.size && player.invulnerable === 0) {
                    player.hp -= enemy.damage;
                    player.invulnerable = 60;
                    updateUI();

                    if (player.hp <= 0) {
                        gameOver();
                    }
                }
            });

            // ÌååÌã∞ÌÅ¥
            particles = particles.filter(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.15;
                p.life--;
                return p.life > 0;
            });

            // Ïä§ÌÇ¨ Ïø®Îã§Ïö¥
            if (Date.now() - lastSkillTime < player.skillCooldown) {
                skillCooldownRemaining = Math.ceil((player.skillCooldown - (Date.now() - lastSkillTime)) / 1000);
                document.getElementById('skillCooldown').textContent = skillCooldownRemaining;
                document.getElementById('skillCooldown').classList.remove('hidden');
            } else {
                document.getElementById('skillCooldown').classList.add('hidden');
            }
        }

        function render() {
            ctx.fillStyle = '#2d2d44';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Í∑∏Î¶¨Îìú
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.lineWidth = 1;
            const gridSize = 40;
            for (let i = 0; i < canvas.width; i += gridSize) {
                ctx.beginPath();
                ctx.moveTo(i, 0);
                ctx.lineTo(i, canvas.height);
                ctx.stroke();
            }
            for (let i = 0; i < canvas.height; i += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, i);
                ctx.lineTo(canvas.width, i);
                ctx.stroke();
            }

            // ÌååÌã∞ÌÅ¥
            particles.forEach(p => {
                const alpha = p.life / p.maxLife;
                ctx.fillStyle = p.color;
                ctx.globalAlpha = alpha;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.globalAlpha = 1;

            // Î∞úÏÇ¨Ï≤¥
            projectiles.forEach(proj => {
                ctx.fillStyle = proj.color;
                ctx.shadowBlur = 15;
                ctx.shadowColor = proj.color;
                ctx.beginPath();
                ctx.arc(proj.x, proj.y, proj.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
            });

            // Ï†Å
            enemies.forEach(enemy => {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.beginPath();
                ctx.ellipse(enemy.x, enemy.y + enemy.size + 3, enemy.size * 0.8, enemy.size * 0.3, 0, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = enemy.color;
                ctx.beginPath();
                ctx.arc(enemy.x, enemy.y, enemy.size, 0, Math.PI * 2);
                ctx.fill();

                ctx.font = `${enemy.size * 1.5}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(enemy.icon, enemy.x, enemy.y);

                // HP Î∞î
                const barWidth = enemy.size * 2;
                const hpPercent = enemy.hp / enemy.maxHp;

                ctx.fillStyle = '#333';
                ctx.fillRect(enemy.x - barWidth / 2, enemy.y - enemy.size - 12, barWidth, 4);
                
                ctx.fillStyle = hpPercent > 0.5 ? '#4CAF50' : '#e74c3c';
                ctx.fillRect(enemy.x - barWidth / 2, enemy.y - enemy.size - 12, barWidth * hpPercent, 4);
            });

            // ÌîåÎ†àÏù¥Ïñ¥
            if (player.invulnerable === 0 || Math.floor(Date.now() / 100) % 2 === 0) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.beginPath();
                ctx.ellipse(player.x, player.y + player.size + 3, player.size * 0.8, player.size * 0.3, 0, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = player.color;
                ctx.beginPath();
                ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2);
                ctx.fill();

                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 3;
                ctx.stroke();

                ctx.font = `${player.size * 1.2}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(player.icon, player.x, player.y);
            }
        }

        function updateUI() {
            const hpPercent = (player.hp / player.maxHp) * 100;
            const hpBar = document.getElementById('hpBar');
            hpBar.style.width = Math.max(0, hpPercent) + '%';
            hpBar.textContent = `${Math.max(0, Math.floor(player.hp))}/${player.maxHp}`;
            
            if (hpPercent < 30) {
                hpBar.classList.add('low');
            } else {
                hpBar.classList.remove('low');
            }

            document.getElementById('levelDisplay').textContent = `Î†àÎ≤®: ${level}`;
            
            const expPercent = (exp / expToNextLevel) * 100;
            document.getElementById('expBar').style.width = expPercent + '%';
            
            document.getElementById('scoreDisplay').textContent = `Ï†êÏàò: ${score.toLocaleString()}`;
        }

        async function gameOver() {
            gameState = 'gameover';
            
            // FirebaseÏóê Ï†êÏàò Ï†ÄÏû•
            await window.saveScore(trainerNameValue, pokemonData[selectedPokemon].name, level, score, kills);
            
            document.getElementById('finalLevel').textContent = level;
            document.getElementById('finalScore').textContent = score.toLocaleString();
            document.getElementById('finalKills').textContent = kills;
            document.getElementById('gameOverScreen').classList.remove('hidden');
        }
    </script>
</body>
</html>
